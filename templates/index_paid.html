<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, user-scalable=no"
  />
  <title>スロット分析ツール</title>

  <!-- フォント -->
  <link
    href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c&display=swap"
    rel="stylesheet"
  />

  <style>
    /* =====================================================
       ベース
    ===================================================== */
    html, body {
      overflow-x: hidden;
      max-width: 100vw;
    }
    body {
      font-family: 'M PLUS Rounded 1c', sans-serif;
      max-width: 800px;
      margin: 10px auto 40px; /* 上10px, 下40px */
      padding: 5px 20px;
    }
    h1 {
      text-align: center;
      margin: 10px 0 0;
      font-size: 24px;
    }

    /* =====================================================
       フォーム
    ===================================================== */
    form {
      display: grid;
      grid-template-columns: 150px 1fr; /* 左ラベル, 右入力 */
      gap: 14px 20px;
      background-color: #fff;
      padding: 20px;
      border-radius: 12px;
      margin-top: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    label {
      display: flex;
      align-items: center;
      font-weight: bold;
      color: #1f2937;
      width: 100%;
      box-sizing: border-box;
      font-size: 12px;
    }
    select,
    input[type="number"] {
      padding: 4px 8px;
      font-size: 12px;
      border: 1px solid #aaa;
      border-radius: 6px;
      box-sizing: border-box;
      width: 100%;
      max-width: 100%;
      height: 32px;
      -webkit-text-size-adjust: 100%;
    }
    select:focus,
    input[type="number"]:focus {
      border-color: #6366f1;
      outline: none;
    }

    /* ボタン行 */
    .form-buttons {
      grid-column: 1 / -1;
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 10px;
    }
    .reset-btn,
    input[type="submit"] {
      padding: 12px 20px;
      font-size: 15px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: all 0.2s ease;
      width: 140px; /* 幅を統一 */
    }
    .reset-btn {
      background-color: #f87171; /* 赤 */
      color: #fff;
    }
    input[type="submit"] {
      background-color: #60a5fa; /* 青 */
      color: #fff;
    }

    /* =====================================================
       結果/エラー表示
    ===================================================== */
    .result {
      margin-top: 20px;
      background-color: #f0fdf4;
      border-left: 5px solid #34d399;
      padding: 16px;
      border-radius: 8px;
      font-size: 15px;
      color: #065f46;
    }
    .error {
      background-color: #fef2f2;
      border-left: 5px solid #ef4444;
      color: #991b1b;
      padding: 16px;
      border-radius: 8px;
      margin-top: 24px;
    }
    .text-red { color: red; font-weight: bold; }
    .text-blue { color: blue; font-weight: bold; }

    /* =====================================================
       詳細条件（開閉セクション）
    ===================================================== */
    #advanced-section {
      grid-column: 1 / -1;
      display: none;                 /* 初期は非表示（JSで制御） */
      grid-template-columns: inherit;
      gap: 12px 20px;
    }
    .toggle-btn {
      grid-column: 1 / -1;
      padding: 4px 12px;
      font-size: 14px;
      background-color: #eee;
      border: 1px solid #aaa;
      border-radius: 4px;
      cursor: pointer;
      text-align: left;
      margin: 4px 0 6px;
    }

    /* =====================================================
       OGPカード用CSS
    ===================================================== */
    .og-card{
      display:flex;
      gap:12px;
      text-decoration:none;
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:12px;
      margin-top:14px;
      align-items:flex-start;
      transition:transform .06s ease, box-shadow .06s ease;
    }
    .og-card:hover{
      transform: translateY(-1px);
      box-shadow:0 2px 10px rgba(0,0,0,.08);
    }
    .og-thumb{
      flex:0 0 120px;
      max-width:120px;
      aspect-ratio: 1.8/1;
      overflow:hidden;
      border-radius:8px;
      background:#f8fafc;
    }
    .og-thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .og-body{ min-width:0; }
    .og-title{
      font-weight:700;
      color:#111827;
      line-height:1.3;
      margin-bottom:4px;
    }
    .og-desc{
      color:#4b5563;
      font-size:0.95rem;
      line-height:1.5;
      max-height:3.0em;
      overflow:hidden;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
    }
    .og-site{
      color:#6b7280;
      font-size:0.85rem;
      margin-top:6px;
    }
  </style>
</head>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-HXM85ZV043');
</script>

<body>
  <!-- タイトル -->
  <h1 style="display:flex; align-items:center; justify-content:center; gap:10px;">
    <img src="{{ url_for('static', filename='icon.jpg') }}" alt="左画像" style="height:24px;">
    <span>スロット分析ツール</span>
    <img src="{{ url_for('static', filename='icon.jpg') }}" alt="右画像" style="height:24px;">
  </h1>

  <!-- メインフォーム -->
  <form id="myForm" method="POST" action="/{{ url_path }}">
    <!-- 機種名 -->
    <label for="machine">機種名</label>
    <select name="machine" id="machine" required>
      <option value="{{ machine_name }}" selected>{{ machine_name }}</option>
    </select>

    <!-- モード（表示用と送信用hidden） -->
    <label for="mode">{{ labels.get("mode", "ボーナス／AT") }}</label>
    <select name="mode_display" id="mode" required>
      {% for opt in mode_options %}
        <option value="{{ opt }}" {% if opt == selected_mode %}selected{% endif %}>{{ opt }}</option>
      {% endfor %}
    </select>
    <input type="hidden" name="mode" id="mode_hidden" value="{{ selected_mode }}">

    <!-- 朝イチ/朝イチ以外 -->
    <label for="time">朝イチ／朝イチ以外</label>
    <select name="time" id="time" required>
      <option value="朝イチ" {% if selected_time == "朝イチ" %}selected{% endif %}>朝イチ</option>
      <option value="朝イチ以外" {% if selected_time == "朝イチ以外" %}selected{% endif %}>朝イチ以外</option>
    </select>

    <!-- 打ち出しゲーム数 -->
    <label for="game">打ち出しG数</label>
    <input
      type="number"
      id="game"
      name="game"
      min="0"
      value="{{ input_game }}"
      required
      inputmode="numeric"
      pattern="[0-9]*"
    >

    <!-- スルー回数（表示用＋送信用hidden） -->
    <label for="through">スルー回数</label>
    <select name="through_display" id="through" required data-selected="{{ selected_through }}">
      {% for opt in through_options %}
        <option value="{{ opt }}" {% if opt == selected_through %}selected{% endif %}>{{ opt }}</option>
      {% endfor %}
    </select>
    <input type="hidden" name="through" id="through_hidden" value="{{ selected_through }}">

    <!-- 詳細条件の開閉ボタン -->
    <button type="button" id="toggle-detail" class="toggle-btn">▼ 詳細条件を表示（前回条件）</button>

    <!-- 詳細条件（POST後は開いた状態にする） -->
    <div id="advanced-section" style="{{ 'display: grid;' if request.method == 'POST' else 'display: none;' }}">
      <!-- 各詳細項目：表示用select + hidden -->
      <label for="at_gap">{{ labels.get("at_gap", "AT間G数") }}</label>
      <select name="at_gap_display" id="at_gap" required data-selected="{{ selected_at_gap }}">
        {% for opt in at_gap_options %}
          <option value="{{ opt }}" {% if opt == selected_at_gap %}selected{% endif %}>{{ opt }}</option>
        {% endfor %}
      </select>
      <input type="hidden" name="at_gap" id="at_gap_hidden" value="{{ selected_at_gap }}">

      <label for="prev_diff">{{ labels.get("prev_diff", "前回差枚数") }}</label>
      <select name="prev_diff_display" id="prev_diff" required data-selected="{{ selected_prev_diff }}">
        {% for opt in prev_diff_options %}
          <option value="{{ opt }}" {% if opt == selected_prev_diff %}selected{% endif %}>{{ opt }}</option>
        {% endfor %}
      </select>
      <input type="hidden" name="prev_diff" id="prev_diff_hidden" value="{{ selected_prev_diff }}">

      <label for="prev_game">{{ labels.get("prev_game", "前回当選G数") }}</label>
      <select name="prev_game_display" id="prev_game" required data-selected="{{ selected_prev_game }}">
        {% for opt in prev_game_options %}
          <option value="{{ opt }}" {% if opt == selected_prev_game %}selected{% endif %}>{{ opt }}</option>
        {% endfor %}
      </select>
      <input type="hidden" name="prev_game" id="prev_game_hidden" value="{{ selected_prev_game }}">

      <label for="prev_coin">{{ labels.get("prev_coin", "前回獲得枚数") }}</label>
      <select name="prev_coin_display" id="prev_coin" required data-selected="{{ selected_prev_coin }}">
        {% for opt in prev_coin_options %}
          <option value="{{ opt }}" {% if opt == selected_prev_coin %}selected{% endif %}>{{ opt }}</option>
        {% endfor %}
      </select>
      <input type="hidden" name="prev_coin" id="prev_coin_hidden" value="{{ selected_prev_coin }}">

      <label for="prev_renchan">{{ labels.get("prev_renchan", "前回連荘数") }}</label>
      <select name="prev_renchan_display" id="prev_renchan" required data-selected="{{ selected_prev_renchan }}">
        {% for opt in prev_renchan_options %}
          <option value="{{ opt }}" {% if opt == selected_prev_renchan %}selected{% endif %}>{{ opt }}</option>
        {% endfor %}
      </select>
      <input type="hidden" name="prev_renchan" id="prev_renchan_hidden" value="{{ selected_prev_renchan }}">

      <label for="prev_type">{{ labels.get("prev_type", "前回種別") }}</label>
      <select name="prev_type_display" id="prev_type" required data-selected="{{ selected_prev_type }}">
        {% for opt in prev_type_options %}
          <option value="{{ opt }}" {% if opt == selected_prev_type %}selected{% endif %}>{{ opt }}</option>
        {% endfor %}
      </select>
      <input type="hidden" name="prev_type" id="prev_type_hidden" value="{{ selected_prev_type }}">

      <label for="custom_condition">{{ labels.get("custom_condition", "機種別条件") }}</label>
      <select name="custom_condition_display" id="custom_condition" required data-selected="{{ selected_custom_condition }}">
        {% for opt in custom_condition_options %}
          <option value="{{ opt }}" {% if opt == selected_custom_condition %}selected{% endif %}>{{ opt }}</option>
        {% endfor %}
      </select>
      <input type="hidden" name="custom_condition" id="custom_condition_hidden" value="{{ selected_custom_condition }}">
    </div>

    <!-- ボタン群 -->
    <div class="form-buttons">
      <button type="button" id="reset-btn" class="reset-btn">リセット</button>
      <input type="submit" value="出力">
    </div>
  </form>

  <!-- エラーメッセージ -->
  {% if error_msg %}
    <div id="error-area" class="error">{{ error_msg }}</div>
  {% endif %}

  <!-- 出力結果 -->
  <div class="result" id="result-area">
    <p id="result-title"><strong>【出力結果】</strong></p>

    {% if result == "サンプル不足" %}
      <p>サンプル不足のため、出力できません。</p>

    {% elif result %}
      <table id="result-table">
        <tbody>
          <tr><th>件数：</th><td>{{ result["件数"] }}</td></tr>
          <tr><th>初当たり：</th><td>{{ result["平均REGゲーム数"] }}</td></tr>
          <tr><th>獲得枚数：</th><td>{{ result["平均AT枚数"] }}</td></tr>
          <tr>
            <th>機械割：</th>
            <td>
              <span class="{{ 'text-red' if result['機械割'] | replace('%', '') | float < 100 else 'text-blue' }}">
                {{ result["機械割"] }}
              </span>
            </td>
          </tr>
          <tr>
            <th>期待値：</th>
            <td>
              <span class="{{ 'text-red' if result['期待値'] | replace('円', '') | replace(',', '') | int < 0 else 'text-blue' }}">
                {{ result["期待値"] }}
              </span>
            </td>
          </tr>
        </tbody>
      </table>
    {% else %}
      <p>ここに出力結果が表示されます。</p>
    {% endif %}
  </div>

  <!-- noteリンク -->
  {% if link_preview %}
    <a class="og-card" href="{{ link_preview.url }}" target="_blank" rel="noopener">
      {% if link_preview.image %}
        <div class="og-thumb">
          <img src="{{ link_preview.image }}" alt="">
        </div>
      {% endif %}
      <div class="og-body">
        <div class="og-title">{{ link_preview.title }}</div>
        {% if link_preview.description %}
          <div class="og-desc">{{ link_preview.description }}</div>
        {% endif %}
        <div class="og-site">{{ link_preview.site_name or link_preview.url }}</div>
      </div>
    </a>
  {% endif %}

  <!-- =====================================================
       JS：リセット（選択肢＆結果表示を初期化）
  ====================================================== -->
  <script>
    document.getElementById("reset-btn").addEventListener("click", (e) => {
      e.preventDefault();

      const ids = [
        "through","at_gap","prev_game","prev_coin",
        "prev_diff","prev_renchan","prev_type","custom_condition"
      ];

      ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = "不問";
        const hidden = document.getElementById(`${id}_hidden`);
        if (hidden) hidden.value = "不問";
      });

      const resultArea = document.getElementById("result-area");
      resultArea.innerHTML = `
        <p id="result-title"><strong>【出力結果】</strong></p>
        <p>ここに出力結果が表示されます。</p>
      `;
    });
  </script>

  <!-- =====================================================
       JS：0スルー時は AT間G数 を不問固定
  ====================================================== -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const atGapSelect = document.getElementById("at_gap");
      const throughSelect = document.getElementById("through");
      if (!atGapSelect || !throughSelect) return;

      // 初期選択肢を保存
      const originalAtGapOptions = Array.from(atGapSelect.options).map(opt => ({
        value: opt.value, text: opt.text
      }));

      function updateAtGapBasedOnThrough() {
        const throughValue = throughSelect.value;

        if (throughValue === "0スルー") {
          atGapSelect.innerHTML = "";
          const option = document.createElement("option");
          option.value = "不問";
          option.textContent = "不問";
          atGapSelect.appendChild(option);
          atGapSelect.disabled = true;
        } else {
          atGapSelect.innerHTML = "";
          originalAtGapOptions.forEach(opt => {
            const option = document.createElement("option");
            option.value = opt.value;
            option.textContent = opt.text;
            if (opt.value === atGapSelect.dataset.selected) option.selected = true;
            atGapSelect.appendChild(option);
          });
          atGapSelect.disabled = false;
        }
      }

      updateAtGapBasedOnThrough();
      throughSelect.addEventListener("change", updateAtGapBasedOnThrough);
    });
  </script>

  <!-- =====================================================
       JS：モード選択肢（Flask → JS へ受け渡し）
  ====================================================== -->
  <script>
    const modeOptionsByMachine = {{ mode_options_map | tojson }};
  </script>

  <!-- =====================================================
       JS：ロック対象（機種ごと）＋ 朝イチ時の制御
  ====================================================== -->
  <script>
    const lockedFieldMap = {{ locked_field_map | tojson }};
    const asaichiTargets = ["prev_game","prev_coin","prev_diff","prev_renchan","prev_type"];
    const originalOptions = {};

    document.addEventListener("DOMContentLoaded", () => {
      // ① 機種名は常にロック
      const machineEl = document.getElementById("machine");
      if (machineEl) machineEl.disabled = true;

      // 既存：原本退避（復元に必要）
      [...asaichiTargets, "through", "at_gap", "custom_condition"].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          originalOptions[id] = Array.from(el.options).map(opt => ({
            value: opt.value, text: opt.text
          }));
        }
      });

      updateFieldLocking(document.getElementById("machine").value);
      updateAsaichiLocking(document.getElementById("time").value);
    });

    // 機種ごとのロック
    function updateFieldLocking(machineName) {
      const lockTargets = lockedFieldMap[machineName] || [];
      const allTargets = ["through","at_gap","custom_condition"];

      allTargets.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;

        if (lockTargets.includes(id)) {
          el.disabled = true;
          restoreSingleOption(el, "不問");
        } else {
          restoreOriginalOptions(id, el);
          el.disabled = false;
        }
      });

      const modeEl = document.getElementById("mode");
      if (modeEl) modeEl.disabled = lockTargets.includes("mode");
    }

    // 朝イチのときは一部項目を不問固定
    function updateAsaichiLocking(timeValue) {
      const isAsaichi = (timeValue === "朝イチ");

      asaichiTargets.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;

        if (isAsaichi && id !== "through") {
          el.disabled = true;
          restoreSingleOption(el, "不問");
        } else {
          restoreOriginalOptions(id, el);
          el.disabled = false;
        }
      });
    }

    // Selectを「不問」1択にする
    function restoreSingleOption(selectEl, value) {
      selectEl.innerHTML = "";
      const opt = document.createElement("option");
      opt.value = value;
      opt.textContent = value;
      selectEl.appendChild(opt);
      selectEl.value = value;
    }

    // Selectの元の選択肢を復元
    function restoreOriginalOptions(id, selectEl) {
      if (!originalOptions[id]) return;
      const selected = selectEl.dataset.selected;
      selectEl.innerHTML = "";
      originalOptions[id].forEach(opt => {
        const option = document.createElement("option");
        option.value = opt.value;
        option.textContent = opt.text;
        if (opt.value === selected) option.selected = true;
        selectEl.appendChild(option);
      });
    }

    // イベント
    document.getElementById("machine").addEventListener("change", function () {
      updateFieldLocking(this.value);
    });
    document.getElementById("time").addEventListener("change", function () {
      updateAsaichiLocking(this.value);
    });
  </script>

  <!-- =====================================================
       JS：機種変更時に各条件を「不問」に戻す
  ====================================================== -->
  <script>
    function resetFieldsOnMachineChange() {
      const resetTargets = ["through","at_gap","prev_game","prev_coin","prev_diff","prev_renchan","prev_type"];
      resetTargets.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        let option = Array.from(el.options).find(opt => opt.value === "不問");
        if (!option) el.add(new Option("不問", "不問"));
        el.value = "不問";
      });

      const gameInput = document.getElementById("game");
      if (gameInput) gameInput.value = "0";
    }
    document.getElementById("machine").addEventListener("change", () => {
      resetFieldsOnMachineChange();
    });
  </script>

  <!-- =====================================================
       JS：送信後のスクロール位置を復元
  ====================================================== -->
  <script>
    document.getElementById("myForm").addEventListener("submit", function () {
      const scrollY = window.scrollY;
      sessionStorage.setItem("scrollPosition", scrollY);
    });
    window.addEventListener("load", function () {
      const savedY = sessionStorage.getItem("scrollPosition");
      if (savedY !== null) {
        window.scrollTo(0, parseInt(savedY));
        sessionStorage.removeItem("scrollPosition");
      }
    });
  </script>

  <!-- =====================================================
       JS：詳細条件トグル（状態保持）
  ====================================================== -->
  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const section = document.getElementById("advanced-section");
      const button  = document.getElementById("toggle-detail");
      const keepOpen = sessionStorage.getItem("keepAdvancedOpen") === "true";

      section.style.display = keepOpen ? "grid" : "none";
      if (button) button.textContent = keepOpen ? "▲ 詳細条件を隠す（前回条件）" : "▼ 詳細条件を表示（前回条件）";

      if (button) {
        button.addEventListener("click", () => {
          const isVisible = section.style.display === "grid";
          section.style.display = isVisible ? "none" : "grid";
          button.textContent = isVisible ? "▼ 詳細条件を表示（前回条件）" : "▲ 詳細条件を隠す（前回条件）";
          sessionStorage.setItem("keepAdvancedOpen", String(!isVisible));
        });
      }
    });
  </script>

  <!-- =====================================================
       JS：select値をhiddenへコピーして送信（name整合のため）
  ====================================================== -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      document.getElementById("myForm").addEventListener("submit", function (e) {
        e.preventDefault(); // 一旦止める

        const syncFields = [
          "mode","through","at_gap",
          "prev_game","prev_coin","prev_diff",
          "prev_renchan","prev_type","custom_condition"
        ];

        syncFields.forEach(id => {
          const select = document.getElementById(id);
          const hidden = document.getElementById(`${id}_hidden`);
          if (select && hidden) hidden.value = select.value;
        });

        this.submit(); // コピー後に送信
      });
    });
  </script>
</body>
</html>
