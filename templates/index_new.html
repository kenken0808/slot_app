<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>けんけんスロット分析ツール</title>

  <!-- フォント -->
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c&display=swap" rel="stylesheet">

  <style>
    html, body { overflow-x: hidden; max-width: 100vw; }
    body { font-family: 'M PLUS Rounded 1c', sans-serif; max-width: 800px; margin: 10px auto 40px; padding: 5px 20px; }
    h1 { text-align: center; margin: 10px 0 0; font-size: 20px; }

    form { display: grid; grid-template-columns: 150px 1fr; gap: 14px 20px; background-color: #fff; padding: 20px; border-radius: 12px; margin-top: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    label { display: flex; align-items: center; font-weight: bold; color: #1f2937; width: 100%; box-sizing: border-box; font-size: 12px; }
    select, input[type="number"] { padding: 4px 8px; font-size: 12px; border: 1px solid #aaa; border-radius: 6px; box-sizing: border-box; width: 100%; height: 32px; }
    select:focus, input[type="number"]:focus { border-color: #6366f1; outline: none; }

    .form-buttons { grid-column: 1 / -1; display: flex; justify-content: center; gap: 20px; margin-top: 10px; }
    .reset-btn, input[type="submit"] { padding: 12px 20px; font-size: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; width: 140px; }
    .reset-btn { background-color: #f87171; color: #fff; }
    input[type="submit"] { background-color: #60a5fa; color: #fff; }

    .result { margin-top: 20px; background-color: #f0fdf4; border-left: 5px solid #34d399; padding: 16px; border-radius: 8px; font-size: 15px; color: #065f46; }
    .error { background-color: #fef2f2; border-left: 5px solid #ef4444; color: #991b1b; padding: 16px; border-radius: 8px; margin-top: 24px; }
    .text-red { color: red; font-weight: bold; }
    .text-blue { color: blue; font-weight: bold; }

    #advanced-section { grid-column: 1 / -1; display: none; grid-template-columns: inherit; gap: 12px 20px; }
    .toggle-btn { grid-column: 1 / -1; padding: 4px 12px; font-size: 14px; background-color: #eee; border: 1px solid #aaa; border-radius: 4px; cursor: pointer; text-align: left; margin: 4px 0 6px; }
  </style>
</head>

<body>
  <h1>けんけんスロット分析ツール</h1>

  <form id="myForm" method="POST" action="/{{ url_path }}">
    <!-- 機種名 -->
    <label for="machine">機種名</label>
    <select name="machine" id="machine" required>
      <option value="{{ machine_name }}" selected>{{ machine_name }}</option>
    </select>

    <!-- モード -->
    <label for="mode">{{ labels.get("mode", "ボーナス／AT") }}</label>
    <select name="mode_display" id="mode" required>
      {% for opt in mode_options %}
        <option value="{{ opt }}" {% if opt == selected_mode %}selected{% endif %}>{{ opt }}</option>
      {% endfor %}
    </select>
    <input type="hidden" name="mode" id="mode_hidden" value="{{ selected_mode }}">

    <!-- 朝イチ/朝イチ以外 -->
    <label for="time">朝イチ／朝イチ以外</label>
    <select name="time" id="time" required>
      <option value="朝イチ" {% if selected_time == "朝イチ" %}selected{% endif %}>朝イチ</option>
      <option value="朝イチ以外" {% if selected_time == "朝イチ以外" %}selected{% endif %}>朝イチ以外</option>
    </select>

    <!-- 打ち出しG数 -->
    <label for="game">打ち出しG数</label>
    <input type="number" id="game" name="game" min="0" value="{{ input_game }}" required>

    <!-- スルー回数 -->
    <label for="through">{{ labels.get("through", "スルー回数") }}</label>
    <select name="through_display" id="through" required data-selected="{{ selected_through }}">
      {% for opt in through_options %}
        <option value="{{ opt }}" {% if opt == selected_through %}selected{% endif %}>{{ opt }}</option>
      {% endfor %}
    </select>
    <input type="hidden" name="through" id="through_hidden" value="{{ selected_through }}">

    <!-- 詳細条件トグル -->
    <button type="button" id="toggle-detail" class="toggle-btn">▼ 詳細条件を表示（前回条件）</button>

    <div id="advanced-section" style="{{ 'display:grid;' if request.method=='POST' else 'display:none;' }}">
      <!-- AT間G数 -->
      <label for="at_gap">{{ labels.get("at_gap", "AT間G数") }}</label>
      <select name="at_gap_display" id="at_gap" required data-selected="{{ selected_at_gap }}">
        {% for opt in at_gap_options %}<option value="{{ opt }}" {% if opt==selected_at_gap %}selected{% endif %}>{{ opt }}</option>{% endfor %}
      </select>
      <input type="hidden" name="at_gap" id="at_gap_hidden" value="{{ selected_at_gap }}">

      <!-- 前回差枚数 -->
      <label for="prev_diff">{{ labels.get("prev_diff", "前回差枚数") }}</label>
      <select name="prev_diff_display" id="prev_diff" required data-selected="{{ selected_prev_diff }}">
        {% for opt in prev_diff_options %}<option value="{{ opt }}" {% if opt==selected_prev_diff %}selected{% endif %}>{{ opt }}</option>{% endfor %}
      </select>
      <input type="hidden" name="prev_diff" id="prev_diff_hidden" value="{{ selected_prev_diff }}">

      <!-- 前回当選G数1 -->
      <label for="prev_game">{{ labels.get("prev_game1", "前回当選G数1") }}</label>
      <select name="prev_game_display" id="prev_game" required data-selected="{{ selected_prev_game }}">
        {% for opt in prev_game_options %}<option value="{{ opt }}" {% if opt==selected_prev_game %}selected{% endif %}>{{ opt }}</option>{% endfor %}
      </select>
      <input type="hidden" name="prev_game" id="prev_game_hidden" value="{{ selected_prev_game }}">

      <!-- 前回当選G数2 -->
      <label for="prev_game2">{{ labels.get("prev_game2", "前回当選G数2") }}</label>
      <select name="prev_game2_display" id="prev_game2" required data-selected="{{ selected_prev_game2 }}">
        {% for opt in prev_game2_options %}<option value="{{ opt }}" {% if opt==selected_prev_game2 %}selected{% endif %}>{{ opt }}</option>{% endfor %}
      </select>
      <input type="hidden" name="prev_game2" id="prev_game2_hidden" value="{{ selected_prev_game2 }}">

      <!-- 前回獲得枚数 -->
      <label for="prev_coin">{{ labels.get("prev_coin", "前回獲得枚数") }}</label>
      <select name="prev_coin_display" id="prev_coin" required data-selected="{{ selected_prev_coin }}">
        {% for opt in prev_coin_options %}<option value="{{ opt }}" {% if opt==selected_prev_coin %}selected{% endif %}>{{ opt }}</option>{% endfor %}
      </select>
      <input type="hidden" name="prev_coin" id="prev_coin_hidden" value="{{ selected_prev_coin }}">

      <!-- 前回連荘数 -->
      <label for="prev_renchan">{{ labels.get("prev_renchan", "前回連荘数") }}</label>
      <select name="prev_renchan_display" id="prev_renchan" required data-selected="{{ selected_prev_renchan }}">
        {% for opt in prev_renchan_options %}<option value="{{ opt }}" {% if opt==selected_prev_renchan %}selected{% endif %}>{{ opt }}</option>{% endfor %}
      </select>
      <input type="hidden" name="prev_renchan" id="prev_renchan_hidden" value="{{ selected_prev_renchan }}">

      <!-- 前回種別 -->
      <label for="prev_type">{{ labels.get("prev_type", "前回種別") }}</label>
      <select name="prev_type_display" id="prev_type" required data-selected="{{ selected_prev_type }}">
        {% for opt in prev_type_options %}<option value="{{ opt }}" {% if opt==selected_prev_type %}selected{% endif %}>{{ opt }}</option>{% endfor %}
      </select>
      <input type="hidden" name="prev_type" id="prev_type_hidden" value="{{ selected_prev_type }}">
    </div>

    <div class="form-buttons">
      <button type="button" id="reset-btn" class="reset-btn">リセット</button>
      <input type="submit" value="出力">
    </div>
  </form>

  {% if error_msg %}<div class="error">{{ error_msg }}</div>{% endif %}

  <div class="result" id="result-area">
    <p id="result-title"><strong>【出力結果】</strong></p>
    {% if result %}
      <table>
        <tr><th>件数：</th><td>{{ result["件数"] }}</td></tr>
        <tr><th>平均REGゲーム数：</th><td>{{ result["平均REGゲーム数"] }}</td></tr>
        <tr><th>平均AT枚数：</th><td>{{ result["平均AT枚数"] }}</td></tr>
        <tr><th>機械割：</th><td><span class="{{ 'text-red' if result['機械割']|replace('%','')|float<100 else 'text-blue' }}">{{ result["機械割"] }}</span></td></tr>
        <tr><th>期待値：</th><td><span class="{{ 'text-red' if result['期待値']|replace('円','')|replace(',','')|int<0 else 'text-blue' }}">{{ result["期待値"] }}</span></td></tr>
      </table>
    {% else %}
      <p>ここに出力結果が表示されます。</p>
    {% endif %}
  </div>

  <script>
    document.getElementById("reset-btn").addEventListener("click", ()=>{
      const ids = ["through","at_gap","prev_game","prev_game2","prev_coin","prev_diff","prev_renchan","prev_type"];
      ids.forEach(id=>{
        const el=document.getElementById(id); if(el) el.value="不問";
        const hidden=document.getElementById(id+"_hidden"); if(hidden) hidden.value="不問";
      });
      const resultArea=document.getElementById("result-area");
      resultArea.innerHTML=`<p id="result-title"><strong>【出力結果】</strong></p><p>ここに出力結果が表示されます。</p>`;
    });

    // 詳細条件トグル
    const toggleBtn=document.getElementById("toggle-detail");
    const advSection=document.getElementById("advanced-section");
    toggleBtn.addEventListener("click",()=>{
      const visible=advSection.style.display==="grid";
      advSection.style.display=visible?"none":"grid";
      toggleBtn.textContent=visible?"▼ 詳細条件を表示（前回条件）":"▲ 詳細条件を隠す（前回条件）";
    });

    // hiddenへ同期
    document.getElementById("myForm").addEventListener("submit", function(e){
      e.preventDefault();
      const syncFields=["mode","through","at_gap","prev_game","prev_game2","prev_coin","prev_diff","prev_renchan","prev_type"];
      syncFields.forEach(id=>{
        const select=document.getElementById(id);
        const hidden=document.getElementById(id+"_hidden");
        if(select && hidden) hidden.value=select.value;
      });
      this.submit();
    });
  </script>
</body>
</html>
