<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, user-scalable=no"
  />

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="けんけんスロット分析ツール">
  <meta property="og:description" content="実践データから機械割や期待値を自動計算できる分析ツールです。">
  <meta property="og:url" content="{{ og_url }}">
  <meta property="og:image" content="{{ og_image }}">
  <meta property="og:site_name" content="けんけんスロット分析ツール">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="けんけんスロット分析ツール">
  <meta name="twitter:description" content="けんけんスロット分析ツール">
  <meta name="twitter:image" content="{{ tw_image }}">

  <title>けんけんスロット分析ツール</title>

  <!-- フォント -->
  <link
    href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c&display=swap"
    rel="stylesheet"
  />

  <style>
    /* ここは元のまま省略 */
  </style>
</head>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-HXM85ZV043"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-HXM85ZV043');
</script>

<body>
  <h1 style="display:flex; align-items:center; justify-content:center; gap:10px;">
    <img src="{{ url_for('static', filename='icon.jpg') }}" alt="左画像" style="height:24px;">
    <span>けんけんスロット分析ツール</span>
    <img src="{{ url_for('static', filename='icon.jpg') }}" alt="右画像" style="height:24px;">
  </h1>

  <form id="myForm" method="POST" action="/{{ machine_key }}/{{ plan_type }}">
    <!-- 機種名 -->
    <label for="machine">機種名</label>
    <select name="machine" id="machine" required>
      <option value="{{ machine_name }}" selected>{{ machine_name }}</option>
    </select>

    <!-- モード -->
    <label for="mode">{{ labels.get("mode", "ボーナス／AT") }}</label>
    <select name="mode_display" id="mode" required>
      {% for opt in mode_options %}
        <option value="{{ opt }}" {% if opt == selected_mode %}selected{% endif %}>{{ opt }}</option>
      {% endfor %}
    </select>
    <input type="hidden" name="mode" id="mode_hidden" value="{{ selected_mode }}">

    <!-- 朝イチ/朝イチ以外 -->
    <label for="time">朝イチ／朝イチ以外</label>
    <select name="time" id="time" required>
      <option value="朝イチ" {% if selected_time == "朝イチ" %}selected{% endif %}>朝イチ</option>
      <option value="朝イチ以外" {% if selected_time == "朝イチ以外" %}selected{% endif %}>朝イチ以外</option>
    </select>

    <!-- 打ち出しG数 -->
    <label for="game">打ち出しG数</label>
    <input
      type="number"
      id="game"
      name="game"
      min="0"
      value="{{ input_game }}"
      required
      inputmode="numeric"
      pattern="[0-9]*"
    >

    <!-- スルー回数 -->
    <label for="through">スルー回数</label>
    <select name="through_display" id="through" required data-selected="{{ selected_through }}">
      {% for opt in through_options %}
        <option value="{{ opt }}" {% if opt == selected_through %}selected{% endif %}>{{ opt }}</option>
      {% endfor %}
    </select>
    <input type="hidden" name="through" id="through_hidden" value="{{ selected_through }}">

    <!-- 詳細条件の開閉ボタン -->
    <button type="button" id="toggle-detail" class="toggle-btn">▼ 詳細条件を表示（前回条件）</button>

    <div id="advanced-section" style="{{ 'display: grid;' if request.method == 'POST' else 'display: none;' }}">
      {% for key, options in detailed_options.items() %}
        <label for="{{ key }}">{{ labels.get(key, key) }}</label>
        <select name="{{ key }}_display" id="{{ key }}" required data-selected="{{ selected_values[key] }}">
          {% for opt in options %}
            <option value="{{ opt }}" {% if opt == selected_values[key] %}selected{% endif %}>{{ opt }}</option>
          {% endfor %}
        </select>
        <input type="hidden" name="{{ key }}" id="{{ key }}_hidden" value="{{ selected_values[key] }}">
      {% endfor %}
    </div>

    <div class="form-buttons">
      <button type="button" id="reset-btn" class="reset-btn">リセット</button>
      <input type="submit" value="出力">
    </div>
  </form>

  {% if error_msg %}
    <div id="error-area" class="error">{{ error_msg }}</div>
  {% endif %}

  <div class="result" id="result-area">
    <p id="result-title"><strong>【出力結果】</strong></p>

    {% if result == "サンプル不足" %}
      <p>サンプル不足のため、出力できません。</p>
    {% elif result %}
      <table id="result-table">
        <tbody>
          <tr><th>件数：</th><td>{{ result["件数"] }}</td></tr>
          <tr><th>初当たり：</th><td>{{ result["平均REGゲーム数"] }}</td></tr>
          <tr><th>獲得枚数：</th><td>{{ result["平均AT枚数"] }}</td></tr>
          <tr>
            <th>機械割：</th>
            <td>
              <span class="{{ 'text-red' if result['機械割'] | replace('%', '') | float < 100 else 'text-blue' }}">
                {{ result["機械割"] }}
              </span>
            </td>
          </tr>
          <tr>
            <th>期待値：</th>
            <td>
              <span class="{{ 'text-red' if result['期待値'] | replace('円', '') | replace(',', '') | int < 0 else 'text-blue' }}">
                {{ result["期待値"] }}
              </span>
            </td>
          </tr>
        </tbody>
      </table>
    {% else %}
      <p>ここに出力結果が表示されます。</p>
    {% endif %}
  </div>

  {% if link_preview %}
    <a class="og-card" href="{{ link_preview.url }}" target="_blank" rel="noopener">
      {% if link_preview.image %}
        <div class="og-thumb">
          <img src="{{ link_preview.image }}" alt="">
        </div>
      {% endif %}
      <div class="og-body">
        <div class="og-title">{{ link_preview.title }}</div>
        {% if link_preview.description %}
          <div class="og-desc">{{ link_preview.description }}</div>
        {% endif %}
        <div class="og-site">{{ link_preview.site_name or link_preview.url }}</div>
      </div>
    </a>
  {% endif %}

  <!-- =====================================================
       JS：リセット（選択肢＆結果表示を初期化）
  ====================================================== -->
  <script>
    document.getElementById("reset-btn").addEventListener("click", (e) => {
      e.preventDefault();

      const ids = [
        "through","at_gap","prev_game","prev_coin",
        "prev_diff","prev_renchan","prev_type","custom_condition"
      ];

      ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = "不問";
        const hidden = document.getElementById(`${id}_hidden`);
        if (hidden) hidden.value = "不問";
      });

      const resultArea = document.getElementById("result-area");
      resultArea.innerHTML = `
        <p id="result-title"><strong>【出力結果】</strong></p>
        <p>ここに出力結果が表示されます。</p>
      `;
    });
  </script>

  <!-- =====================================================
       JS：モード選択肢（Flask → JS へ受け渡し）
  ====================================================== -->
  <script>
    const modeOptionsByMachine = {{ mode_options_map | tojson }};
  </script>

  <!-- =====================================================
       JS：ロック対象（機種ごと）＋ 朝イチ時の制御
  ====================================================== -->
<script>
  // サーバから渡すロック設定（表示名キー）
  const lockedFieldMap = {{ locked_field_map | tojson }};

  // ロック対象になり得るIDを一元管理
  const lockableIds = [
    "through","at_gap","prev_diff","prev_game","prev_coin","prev_renchan","prev_type","custom_condition"
  ];

  // ★ 朝イチで不問固定にする対象に at_gap を含める
  const asaichiTargets = ["at_gap","prev_game","prev_coin","prev_diff","prev_renchan","prev_type","custom_condition"];

  // 元の<option>退避
  const originalOptions = {};

  // 現在機種のロック対象を取得
  function getLockTargets() {
    const m = document.getElementById("machine")?.value;
    return lockedFieldMap[m] || [];
  }

  document.addEventListener("DOMContentLoaded", () => {
    // 機種名は常にロック
    const machineEl = document.getElementById("machine");
    if (machineEl) machineEl.disabled = true;

    // 元の選択肢をロック候補すべてで退避
    lockableIds.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        originalOptions[id] = Array.from(el.options).map(opt => ({
          value: opt.value, text: opt.text
        }));
      }
    });

    // 初期適用
    updateFieldLocking(document.getElementById("machine").value);
    updateAsaichiLocking(document.getElementById("time").value);
    updateAtGapBasedOnThrough(); // 0スルー→AT間G数の固定
  });

  // 機種ごとのロック適用
  function updateFieldLocking(machineName) {
    const lockTargets = lockedFieldMap[machineName] || [];

    lockableIds.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;

      if (lockTargets.includes(id)) {
        el.disabled = true;
        restoreSingleOption(el, "不問");
      } else {
        restoreOriginalOptions(id, el);
        el.disabled = false;
      }
    });

    const modeEl = document.getElementById("mode");
    if (modeEl) modeEl.disabled = lockTargets.includes("mode");

    // スルーとの連動は最後に再評価
    updateAtGapBasedOnThrough();
  }

  // 朝イチのときは一部項目を不問固定（機種ロックは維持）
  function updateAsaichiLocking(timeValue) {
    const isAsaichi = (timeValue === "朝イチ");
    const lockTargets = getLockTargets();

    asaichiTargets.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;

      if (isAsaichi && id !== "through") {
        el.disabled = true;
        restoreSingleOption(el, "不問");
      } else {
        restoreOriginalOptions(id, el);
        // 機種ロック対象は解除しない
        el.disabled = lockTargets.includes(id);
        if (el.disabled) restoreSingleOption(el, "不問");
      }
    });
  }

  // 0スルー時は AT間G数 を不問固定（★ 朝イチ最優先）
  function updateAtGapBasedOnThrough() {
    const atGapSelect = document.getElementById("at_gap");
    const throughSelect = document.getElementById("through");
    if (!atGapSelect || !throughSelect) return;

    // ★ 追加：朝イチなら常に at_gap は不問固定＋disabled
    const isAsaichi = document.getElementById("time")?.value === "朝イチ";
    if (isAsaichi) {
      restoreSingleOption(atGapSelect, "不問");
      atGapSelect.disabled = true;
      return;
    }

    const lockTargets = getLockTargets();
    // 機種ロックに at_gap が含まれるなら常に固定
    if (lockTargets.includes("at_gap")) {
      restoreSingleOption(atGapSelect, "不問");
      atGapSelect.disabled = true;
      return;
    }

    // 通常時：0スルーなら固定、それ以外は選択可
    const throughValue = throughSelect.value;
    if (throughValue === "0スルー") {
      restoreSingleOption(atGapSelect, "不問");
      atGapSelect.disabled = true;
    } else {
      restoreOriginalOptions("at_gap", atGapSelect);
      atGapSelect.disabled = false;
    }
  }

  // Select を「不問」1択にする
  function restoreSingleOption(selectEl, value) {
    selectEl.innerHTML = "";
    const opt = document.createElement("option");
    opt.value = value;
    opt.textContent = value;
    selectEl.appendChild(opt);
    selectEl.value = value;
  }

  // Select の元の選択肢を復元
  function restoreOriginalOptions(id, selectEl) {
    if (!originalOptions[id]) return;
    const selected = selectEl.dataset.selected;
    selectEl.innerHTML = "";
    originalOptions[id].forEach(opt => {
      const option = document.createElement("option");
      option.value = opt.value;
      option.textContent = opt.text;
      if (opt.value === selected) option.selected = true;
      selectEl.appendChild(option);
    });
  }

  // イベント
  document.getElementById("machine").addEventListener("change", function () {
    updateFieldLocking(this.value);
    updateAtGapBasedOnThrough(); // 念のため再評価
  });
  document.getElementById("time").addEventListener("change", function () {
    updateAsaichiLocking(this.value);
    updateAtGapBasedOnThrough(); // ★ 朝イチ切替時にも反映
  });
  document.getElementById("through").addEventListener("change", function () {
    updateAtGapBasedOnThrough();
  });
</script>

  <!-- =====================================================
       JS：機種変更時に各条件を「不問」に戻す
  ====================================================== -->
  <script>
    function resetFieldsOnMachineChange() {
      const resetTargets = ["through","at_gap","prev_game","prev_coin","prev_diff","prev_renchan","prev_type"];
      resetTargets.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        let option = Array.from(el.options).find(opt => opt.value === "不問");
        if (!option) el.add(new Option("不問", "不問"));
        el.value = "不問";
      });

      const gameInput = document.getElementById("game");
      if (gameInput) gameInput.value = "0";
    }
    document.getElementById("machine").addEventListener("change", () => {
      resetFieldsOnMachineChange();
    });
  </script>

  <!-- =====================================================
       JS：送信後のスクロール位置を復元
  ====================================================== -->
  <script>
    document.getElementById("myForm").addEventListener("submit", function () {
      const scrollY = window.scrollY;
      sessionStorage.setItem("scrollPosition", scrollY);
    });
    window.addEventListener("load", function () {
      const savedY = sessionStorage.getItem("scrollPosition");
      if (savedY !== null) {
        window.scrollTo(0, parseInt(savedY));
        sessionStorage.removeItem("scrollPosition");
      }
    });
  </script>

  <!-- =====================================================
       JS：詳細条件トグル（状態保持）
  ====================================================== -->
  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const section = document.getElementById("advanced-section");
      const button  = document.getElementById("toggle-detail");
      const keepOpen = sessionStorage.getItem("keepAdvancedOpen") === "true";

      section.style.display = keepOpen ? "grid" : "none";
      if (button) button.textContent = keepOpen ? "▲ 詳細条件を隠す（前回条件）" : "▼ 詳細条件を表示（前回条件）";

      if (button) {
        button.addEventListener("click", () => {
          const isVisible = section.style.display === "grid";
          section.style.display = isVisible ? "none" : "grid";
          button.textContent = isVisible ? "▼ 詳細条件を表示（前回条件）" : "▲ 詳細条件を隠す（前回条件）";
          sessionStorage.setItem("keepAdvancedOpen", String(!isVisible));
        });
      }
    });
  </script>

  <!-- =====================================================
       JS：select値をhiddenへコピーして送信（name整合のため）
  ====================================================== -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      document.getElementById("myForm").addEventListener("submit", function (e) {
        e.preventDefault(); // 一旦止める

        const syncFields = [
          "mode","through","at_gap",
          "prev_game","prev_coin","prev_diff",
          "prev_renchan","prev_type","custom_condition"
        ];

        syncFields.forEach(id => {
          const select = document.getElementById(id);
          const hidden = document.getElementById(`${id}_hidden`);
          if (select && hidden) hidden.value = select.value;
        });

        this.submit(); // コピー後に送信
      });
    });
  </script>

</body>
</html>
