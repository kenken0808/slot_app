<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>けんけんスロット分析ツール</title>
  <style>
    body { font-family: 'M PLUS Rounded 1c', sans-serif; padding: 20px; }
    h1 { text-align:center; }
    form { display:grid; gap:10px; max-width:500px; margin:auto; }
    #advanced-section { display:grid; gap:5px; }
    .form-buttons { display:flex; gap:10px; }
    .result { margin-top:20px; border-top:1px solid #ccc; padding-top:10px; }
    .text-red { color:red; }
    .text-blue { color:blue; }
  </style>
</head>
<body>
<h1>{{ machine_name }}</h1>

<form id="myForm" method="POST" action="/tool">

  <label for="mode">モード</label>
  <select name="mode" id="mode" required>
    {% for opt in mode_options %}
      <option value="{{ opt }}" {% if opt==selected_mode %}selected{% endif %}>{{ opt }}</option>
    {% endfor %}
  </select>

  <label for="time">朝イチ／朝イチ以外</label>
  <select name="time" id="time" required>
    <option value="朝イチ" {% if selected_time=="朝イチ" %}selected{% endif %}>朝イチ</option>
    <option value="朝イチ以外" {% if selected_time=="朝イチ以外" %}selected{% endif %}>朝イチ以外</option>
  </select>

  <label for="through">スルー回数</label>
  <select name="through" id="through" required data-selected="{{ selected_through }}">
    {% for opt in through_options %}
      <option value="{{ opt }}" {% if opt==selected_through %}selected{% endif %}>{{ opt }}</option>
    {% endfor %}
  </select>
  <input type="hidden" id="through_hidden" name="through" value="{{ selected_through }}">

  <button type="button" id="toggle-detail">▼ 詳細条件を表示（前回条件）</button>

  <div id="advanced-section" style="display:none;">
    {% for key, options in detailed_options.items() %}
      <label for="{{ key }}">{{ key }}</label>
      <select name="{{ key }}" id="{{ key }}" data-selected="{{ selected_values[key] }}">
        {% for opt in options %}
          <option value="{{ opt }}" {% if opt==selected_values[key] %}selected{% endif %}>{{ opt }}</option>
        {% endfor %}
      </select>
      <input type="hidden" id="{{ key }}_hidden" name="{{ key }}" value="{{ selected_values[key] }}">
    {% endfor %}
  </div>

  <div class="form-buttons">
    <button type="button" id="reset-btn">リセット</button>
    <input type="submit" value="出力">
  </div>

</form>

<div class="result" id="result-area">
  {% if result %}
    <h2>出力結果</h2>
    <ul>
      <li>件数: {{ result["件数"] }}</li>
      <li>平均REGゲーム数: {{ result["平均REGゲーム数"] }}</li>
      <li>平均AT枚数: {{ result["平均AT枚数"] }}</li>
      <li class="{{ 'text-red' if result['機械割']|replace('%','')|float<100 else 'text-blue' }}">機械割: {{ result["機械割"] }}</li>
      <li class="{{ 'text-red' if result['期待値']|replace('円','')|replace(',','')|int<0 else 'text-blue' }}">期待値: {{ result["期待値"] }}</li>
    </ul>
  {% else %}
    <p>ここに出力結果が表示されます。</p>
  {% endif %}
</div>

<script>
  // 詳細条件トグル
  const toggleBtn = document.getElementById("toggle-detail");
  const advSection = document.getElementById("advanced-section");
  toggleBtn.addEventListener("click", () => {
    const isVisible = advSection.style.display === "grid";
    advSection.style.display = isVisible ? "none" : "grid";
    toggleBtn.textContent = isVisible ? "▼ 詳細条件を表示（前回条件）" : "▲ 詳細条件を隠す（前回条件）";
  });

  // リセットボタン
  document.getElementById("reset-btn").addEventListener("click", () => {
    ["through","at_gap","prev_game","prev_coin","prev_diff"].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.value="不問";
      const hidden = document.getElementById(id+"_hidden");
      if(hidden) hidden.value="不問";
    });
  });

  // submit時 hiddenにコピー
  document.getElementById("myForm").addEventListener("submit", function(e){
    ["through","at_gap","prev_game","prev_coin","prev_diff"].forEach(id=>{
      const el = document.getElementById(id);
      const hidden = document.getElementById(id+"_hidden");
      if(el && hidden) hidden.value = el.value;
    });
  });

</script>
</body>
</html>
