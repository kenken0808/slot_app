<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>期待値ツール</title>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c&display=swap" rel="stylesheet">
  <style>

    html, body {
      overflow-x: hidden;
      max-width: 100vw;
    }

    /* 全体の基本レイアウトと背景グラデーション、フォント設定 */
    body {
      font-family: 'M PLUS Rounded 1c', sans-serif;  /* 丸みのある日本語フォント */
      max-width: 800px;           /* コンテンツ幅の上限 */
      margin: 0 auto;             /* 中央揃え */
      padding: 5px 20px; /* ← ここを調整（上下5px） */
      margin: 40px auto;         /* ← 上下左右に40px余白を追加（中央寄せも） */
      margin-top: 10px;   /* 上の余白を縮める */
    }

    /* タイトルのデザイン */
    h1 {
      text-align: center;         /* 中央寄せ */
      margin-bottom: 0;        /* 下の余白 */
      margin-top: 10px;             /* ← 上の余白なし */
    }

    /* 入力フォームの全体設定 */
    form {
      display: grid;              /* グリッドレイアウトで2列に配置 */
      grid-template-columns: 160px 1fr;
      gap: 14px 20px;             /* 行・列間の余白 */
      background-color: white;   /* 背景白 */
      padding: 20px;
      border-radius: 12px;        /* 角丸 */
      margin-top: 0; /* ← タイトルとの隙間を狭める */
    }

    /* ラベルのデザイン */
      label {
        font-weight: bold;
        word-break: break-word;
        max-width: 220px; /* ←ラベルの最大幅 */
      }

    /* セレクトボックスと数字入力欄の共通設定 */
    select,
    input[type="number"] {
      padding: 4px 8px;
      font-size: 16px; /* iOS ズーム対策：16px 以上でズームされにくい */
      border: 1px solid #aaa;
      border-radius: 6px;
      box-sizing: border-box;
      width: 100%;
      max-width: 100%; /* 追加！ */
      height: 32px;
    }

    /* ボタン全体を中央に整列 */
    .form-buttons {
      grid-column: 1 / -1;        /* グリッド全体を使用 */
      display: flex;
      justify-content: center;
      gap: 20px;
    }

    /* リセットボタンと送信ボタンの共通デザイン */
    .reset-btn,
    input[type="submit"] {
      padding: 12px 20px;
      font-size: 15px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: all 0.2s ease;
    }

    /* リセットボタンのカラー */
    .reset-btn {
      background-color: #f87171;  /* 赤系 */
      color: white;
    }

    /* 出力ボタンのカラー */
    input[type="submit"] {
      background-color: #60a5fa;  /* 水色 */
      color: white;
    }

    /* 出力結果エリア（成功時）の見た目 */
    .result {
      margin-top: 8px; /* ← ここを小さくして詰める（例：8px） */
      background-color: #f0fdf4;      /* 淡い緑背景 */
      border-left: 5px solid #34d399; /* 緑の左ライン */
      padding: 16px;
      border-radius: 8px;
      font-size: 15px;
      color: #065f46;                 /* 緑系文字色 */
    }

    /* エラー表示エリアの見た目 */
    .error {
      background-color: #fef2f2;      /* 淡い赤背景 */
      border-left: 5px solid #ef4444; /* 赤の左ライン */
      color: #991b1b;                 /* 赤系文字色 */
      padding: 16px;
      border-radius: 8px;
      margin-top: 24px;
    }

    .text-red {
      color: red;
      font-weight: bold;
    }
    .text-blue {
      color: blue;
      font-weight: bold;
    }

    /* フォーカス時の強調表示 */
    select:focus,
    input[type="number"]:focus {
      border-color: #6366f1;     /* 青色に変化 */
      outline: none;
    }


























#advanced-section {
  grid-column: 1 / -1;
  display: none;
  grid-template-columns: inherit;
  gap: 12px 20px;
}

.toggle-btn {
  grid-column: 1 / -1;
  padding: 8px 12px;
  font-size: 14px;
  background-color: #eee;
  border: 1px solid #aaa;
  border-radius: 4px;
  cursor: pointer;
  text-align: left;
  margin-bottom: 10px;
}


  </style>
</head>


<body>
  <h1>期待値ツール</h1>
  <form id="myForm" method="POST" action="/">



    <label for="machine">機種名</label>
    <select name="machine" id="machine" required>
      {% for m in machines %}
        <option value="{{m}}" {% if m == selected_machine %}selected{% endif %}>{{m}}</option>
      {% endfor %}
    </select>


    <label for="mode">{{ labels.get("mode", "ボーナス／AT") }}</label>
    <select name="mode_display" id="mode" required>
      {% for opt in mode_options %}
        <option value="{{ opt }}" {% if opt == selected_mode %}selected{% endif %}>{{ opt }}</option>
      {% endfor %}
    </select>
    <input type="hidden" name="mode" id="mode_hidden" value="{{ selected_mode }}">




    <label for="time">朝イチ／朝イチ以外</label>
    <select name="time" id="time" required>
      <option value="朝イチ" {% if selected_time == "朝イチ" %}selected{% endif %}>朝イチ</option>
      <option value="朝イチ以外" {% if selected_time == "朝イチ以外" %}selected{% endif %}>朝イチ以外</option>
    </select>

    <label for="game">打ち出しゲーム数</label>
    <input type="number" id="game" name="game" min="0" value="{{input_game}}" required inputmode="numeric" pattern="[0-9]*">

    <label for="through">スルー回数</label>
    <select name="through_display" id="through" required>
      {% for opt in through_options %}
        <option value="{{opt}}" {% if opt == selected_through %}selected{% endif %}>{{opt}}</option>
      {% endfor %}
    </select>
    <input type="hidden" name="through" id="through_hidden" value="{{ selected_through }}">


  <!-- 項目の開閉ボタン -->
  <button type="button" onclick="toggleAdvanced()" class="toggle-btn">▼ 詳細条件を表示</button>


  <!-- 対象項目 -->
  <div id="advanced-section" style="display: none;">

    <label for="at_gap">{{ labels.get("at_gap", "AT間G数") }}</label>
    <select name="at_gap_display" id="at_gap" required data-selected="{{ selected_at_gap }}">
      {% for opt in at_gap_options %}
        <option value="{{ opt }}" {% if opt == selected_at_gap %}selected{% endif %}>{{ opt }}</option>
      {% endfor %}
    </select>
    <input type="hidden" name="at_gap" id="at_gap_hidden" value="{{ selected_at_gap }}">

    <label for="prev_game">{{ labels.get("prev_game", "前回当選G数") }}</label>
    <select name="prev_game_display" id="prev_game" required data-selected="{{ selected_prev_game }}">
      {% for opt in prev_game_options %}
        <option value="{{ opt }}" {% if opt == selected_prev_game %}selected{% endif %}>{{ opt }}</option>
      {% endfor %}
    </select>
    <input type="hidden" name="prev_game" id="prev_game_hidden" value="{{ selected_prev_game }}">

    <label for="prev_coin">{{ labels.get("prev_coin", "前回獲得枚数") }}</label>
    <select name="prev_coin_display" id="prev_coin" required data-selected="{{ selected_prev_coin }}">
      {% for opt in prev_coin_options %}
        <option value="{{ opt }}" {% if opt == selected_prev_coin %}selected{% endif %}>{{ opt }}</option>
      {% endfor %}
    </select>
    <input type="hidden" name="prev_coin" id="prev_coin_hidden" value="{{ selected_prev_coin }}">

    <label for="prev_diff">{{ labels.get("prev_diff", "前回差枚数") }}</label>
    <select name="prev_diff_display" id="prev_diff" required data-selected="{{ selected_prev_diff }}">
      {% for opt in prev_diff_options %}
        <option value="{{ opt }}" {% if opt == selected_prev_diff %}selected{% endif %}>{{ opt }}</option>
      {% endfor %}
    </select>
    <input type="hidden" name="prev_diff" id="prev_diff_hidden" value="{{ selected_prev_diff }}">

    <label for="prev_renchan">{{ labels.get("prev_renchan", "前回連荘数") }}</label>
    <select name="prev_renchan_display" id="prev_renchan" required data-selected="{{ selected_prev_renchan }}">
      {% for opt in prev_renchan_options %}
        <option value="{{ opt }}" {% if opt == selected_prev_renchan %}selected{% endif %}>{{ opt }}</option>
      {% endfor %}
    </select>
    <input type="hidden" name="prev_renchan" id="prev_renchan_hidden" value="{{ selected_prev_renchan }}">

    <label for="prev_type">{{ labels.get("prev_type", "前回種別") }}</label>
    <select name="prev_type_display" id="prev_type" required data-selected="{{ selected_prev_type }}">
      {% for opt in prev_type_options %}
        <option value="{{ opt }}" {% if opt == selected_prev_type %}selected{% endif %}>{{ opt }}</option>
      {% endfor %}
    </select>
    <input type="hidden" name="prev_type" id="prev_type_hidden" value="{{ selected_prev_type }}">

  </div>


    <button type="button" id="reset-btn" class="reset-btn">リセット</button>
    <input type="submit" value="出力">
  </form>

<!-- エラーメッセージ表示領域 -->
{% if error_msg %}
  <div id="error-area" style="color: red;">{{ error_msg }}</div>
{% endif %}

<!-- 出力結果表示領域 -->
<div class="result" id="result-area">
  <p id="result-title"><strong>【出力結果】</strong></p>

  {% if result == "サンプル不足" %}
    <p>サンプル不足のため、出力できません。</p>

  {% elif result %}
    <table id="result-table">
      <tbody>
        <tr><th>件数：</th><td>{{ result["件数"] }}</td></tr>
        <tr><th>初当たり：</th><td>{{ result["平均REGゲーム数"] }}</td></tr>
        <tr><th>獲得枚数：</th><td>{{ result["平均AT枚数"] }}</td></tr>
        <tr>
          <th>機械割：</th>
          <td>
            <span class="{{ 'text-red' if result['機械割'] | replace('%', '') | float < 100 else 'text-blue' }}">
              {{ result["機械割"] }}
            </span>
          </td>
        </tr>
        <tr>
          <th>期待値：</th>
          <td>
            <span class="{{ 'text-red' if result['期待値'] | replace('円', '') | replace(',', '') | int < 0 else 'text-blue' }}">
              {{ result["期待値"] }}
            </span>
          </td>
        </tr>
      </tbody>
    </table>

  {% else %}
    <p>ここに出力結果が表示されます。</p>
  {% endif %}
</div>



  <script>
  document.addEventListener("DOMContentLoaded", function () {
    const targetFields = [
      "prev_game", "prev_coin", "prev_diff", "prev_renchan", "prev_type"
    ];

    const originalOptions = {};
    targetFields.forEach(field => {
      const select = document.getElementById(field);
      originalOptions[field] = Array.from(select.options).map(opt => ({ value: opt.value, text: opt.text }));
    });

    document.getElementById("time").addEventListener("change", function () {
      const isAsaichi = this.value === "朝イチ";

      targetFields.forEach(field => {
        const select = document.getElementById(field);
        select.innerHTML = "";

        if (isAsaichi) {
          // 「不問」のみ表示して選択・無効化
          const option = document.createElement("option");
          option.value = "不問";
          option.textContent = "不問";
          select.appendChild(option);
          select.disabled = true;
        } else {
          // 元の選択肢を復元し、有効化し、選択状態も復元
          originalOptions[field].forEach(opt => {
            const option = document.createElement("option");
            option.value = opt.value;
            option.textContent = opt.text;
            if (opt.value === select.dataset.selected) {
              option.selected = true;
            }
            select.appendChild(option);
          });
          select.disabled = false;
        }
      });
    });

    // 初回表示時も朝イチなら制限
    const timeSelect = document.getElementById("time");
    const event = new Event("change");
    timeSelect.dispatchEvent(event);
  });
  </script>

<script>
document.getElementById("reset-btn").addEventListener("click", (e) => {
  e.preventDefault();
  const ids = ["through", "at_gap", "prev_game", "prev_coin", "prev_diff", "prev_renchan", "prev_type"];
  ids.forEach(id => {
    const el = document.getElementById(id);
    if(el) el.value = "不問";
  });

  // 出力結果の内容をリセット（ただしエラーメッセージとは分離）
  const resultArea = document.getElementById("result-area");
  resultArea.innerHTML = `
    <p id="result-title"><strong>【出力結果】</strong></p>
    <p>ここに出力結果が表示されます。</p>
  `;
});

</script>

<script>
  const labelMap = {
    "L マギアレコード 魔法少女まどか☆マギカ外伝": {
            "mode": "CZ／ボナ",
            "at_gap": "ボナ間ゲーム数",
            "prev_game": "前回ボナ当選ゲーム数",
            "prev_coin": "前回ボナ獲得枚数",
            "prev_diff": "前回ボナ終了時差枚数",
            "prev_renchan": "前回ボナ連荘数",
            "prev_type": "前回ボナ種別"
    },
    "L ゴッドイーター リザレクション": {
            "mode": "AT",
            "at_gap": "AT間ゲーム数",
            "prev_game": "前回AT当選ゲーム数",
            "prev_coin": "前回AT獲得枚数",
            "prev_diff": "前回AT終了時差枚数",
            "prev_renchan": "前回AT連荘数",
            "prev_type": "前回AT種別"
    }
    // 他の機種も追加
  };

  document.getElementById("machine").addEventListener("change", function () {
    const selected = this.value;
    const labels = labelMap[selected] || {};
    for (const key in labels) {
      const label = document.querySelector(`label[for="${key}"]`);
      if (label) label.textContent = labels[key];
    }
  });

  // 起動時に反映
  document.getElementById("machine").dispatchEvent(new Event("change"));
</script>



<script>
document.addEventListener("DOMContentLoaded", () => {
  const atGapSelect = document.getElementById("at_gap");
  const throughSelect = document.getElementById("through");

  // 初期選択肢を保存
  const originalAtGapOptions = Array.from(atGapSelect.options).map(opt => {
    return { value: opt.value, text: opt.text };
  });

  function updateAtGapBasedOnThrough() {
    const throughValue = throughSelect.value;

    if (throughValue === "0") {
      // 不問にしてロック
      atGapSelect.innerHTML = "";
      const option = document.createElement("option");
      option.value = "不問";
      option.textContent = "不問";
      atGapSelect.appendChild(option);
      atGapSelect.disabled = true;
    } else {
      // 元に戻す
      atGapSelect.innerHTML = "";
      originalAtGapOptions.forEach(opt => {
        const option = document.createElement("option");
        option.value = opt.value;
        option.textContent = opt.text;
        if (opt.value === atGapSelect.dataset.selected) {
          option.selected = true;
        }
        atGapSelect.appendChild(option);
      });
      atGapSelect.disabled = false;
    }
  }

  // 初回と変更時に反映
  updateAtGapBasedOnThrough();
  throughSelect.addEventListener("change", updateAtGapBasedOnThrough);
});
</script>

<script>
  const modeOptionsByMachine = {
    "L マギアレコード 魔法少女まどか☆マギカ外伝": ["CZ", "ボーナス"],
    "L ゴッドイーター リザレクション": ["AT"],
    // 他の機種も追加
  };

  const machineSelect = document.getElementById("machine");
  const modeSelect = document.getElementById("mode");

  const currentMode = "{{ selected_mode }}";  // ← Flask から選択値を取得

  function updateModeOptions(selectedMachine) {
    const options = modeOptionsByMachine[selectedMachine] || [];
    modeSelect.innerHTML = "";

    options.forEach(opt => {
      const optionEl = document.createElement("option");
      optionEl.value = opt;
      optionEl.textContent = opt;
      if (opt === currentMode) {
        optionEl.selected = true;  // ← 現在の選択状態を維持
      }
      modeSelect.appendChild(optionEl);
    });

    // fallback: currentModeが含まれない場合は先頭を選択
    if (!options.includes(currentMode) && options.length > 0) {
      modeSelect.value = options[0];
    }

    // disable も同時に
    modeSelect.disabled = options.length === 0;
  }

  machineSelect.addEventListener("change", function () {
    updateModeOptions(this.value);
  });

  window.addEventListener("DOMContentLoaded", () => {
    updateModeOptions(machineSelect.value);
  });
</script>



<script>
  const specialLockedMachines = ["L ゴッドイーター リザレクション"];

  function updateFieldLocking(machine) {
    const isLocked = specialLockedMachines.includes(machine);

    // fieldごとに制御を分ける
    const modeEl = document.getElementById("mode");
    const throughEl = document.getElementById("through");
    const atGapEl = document.getElementById("at_gap");

    if (modeEl) {
      modeEl.disabled = isLocked;
      // ※ mode は不問にしない（保持）
    }

    if (throughEl) {
      throughEl.disabled = isLocked;
      if (isLocked) {
        if (Array.from(throughEl.options).find(opt => opt.value === "不問")) {
          throughEl.value = "不問";
        }
      }
    }

    if (atGapEl) {
      atGapEl.disabled = isLocked;
      if (isLocked) {
        if (Array.from(atGapEl.options).find(opt => opt.value === "不問")) {
          atGapEl.value = "不問";
        }
      }
    }
  }

  document.getElementById("machine").addEventListener("change", function () {
    const selectedMachine = this.value;
    updateFieldLocking(selectedMachine);
  });

  // 初回も実行
  window.addEventListener("DOMContentLoaded", () => {
    const machine = document.getElementById("machine").value;
    updateFieldLocking(machine);
  });
</script>

<script>
  document.getElementById("myForm").addEventListener("submit", function () {
    const syncFields = [
      "mode", "through", "at_gap", 
      "prev_game", "prev_coin", "prev_diff", 
      "prev_renchan", "prev_type"
    ];
    syncFields.forEach(id => {
      const select = document.getElementById(id);
      const hidden = document.getElementById(`${id}_hidden`);
      if (select && hidden) {
        hidden.value = select.value;
      }
    });
  });
</script>

<script>
  const resetFieldsOnMachineChange = () => {
    // modeはリセットしない
    const resetTargets = [
      "through",
      "at_gap",
      "prev_game",
      "prev_coin",
      "prev_diff",
      "prev_renchan",
      "prev_type"
    ];

    resetTargets.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        // 「不問」があれば選択、なければ追加して選択
        let option = Array.from(el.options).find(opt => opt.value === "不問");
        if (!option) {
          option = new Option("不問", "不問");
          el.add(option);
        }
        el.value = "不問";
      }
    });

    // 打ち出しゲーム数を0にリセット
    const gameInput = document.getElementById("game");
    if (gameInput) {
      gameInput.value = "0";
    }
  };

  document.getElementById("machine").addEventListener("change", () => {
    resetFieldsOnMachineChange();
  });
</script>

<script>
  document.getElementById("myForm").addEventListener("submit", function () {
    const scrollY = window.scrollY;
    sessionStorage.setItem("scrollPosition", scrollY);
  });

  window.addEventListener("load", function () {
    const savedY = sessionStorage.getItem("scrollPosition");
    if (savedY !== null) {
      window.scrollTo(0, parseInt(savedY));
      sessionStorage.removeItem("scrollPosition");
    }
  });
</script>

<script>
  function toggleAdvanced() {
    const section = document.getElementById("advanced-section");
    const button = document.querySelector(".toggle-btn");

    if (section.style.display === "none") {
      section.style.display = "grid";
      button.textContent = "▲ 詳細条件を隠す";
    } else {
      section.style.display = "none";
      button.textContent = "▼ 詳細条件を表示";
    }
  }
</script>


</body>
</html>


